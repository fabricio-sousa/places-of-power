<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="shortcut icon" href="{{url_for('static', filename='pyramid.png')}}">
		<meta property="og:title" content="Places of Power">
		<meta property="og:author" content="Fabricio Sousa">
		<meta property="og:description" content="A collection of Places of Power around the world. View and add your own!">
		<meta property="og:image" content="https://i.imgur.com/E4DZ4nH.jpg">
		<meta property="og:url" content="http://ec2-18-220-254-32.us-east-2.compute.amazonaws.com">
		<title>Places of Power</title>
		
		<!-- Bootstrap core CSS -->
		<link rel=stylesheet type=text/css href="{{url_for('static', filename='bootstrap.min.css')}}">
		<!-- Custom Styles -->
		<link rel=stylesheet type=text/css href="{{url_for('static', filename='custom.css')}}">
		<!-- Jquery javascript -->	
		<script src="{{url_for('static', filename='jquery-3.3.1.min.js')}}"></script>
		
	</head>
	
	<body>
		
			<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
					<a class="navbar-brand" href="{{url_for('showPlaces')}}">Places of Power</a>
					<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
					</button>
					
					<div class="collapse navbar-collapse" id="navbarsExampleDefault">
						<ul class="navbar-nav mr-auto">
							<li class="nav-item active">
								<a class="nav-link" href="{{url_for('addPlace')}}">Add a Place</a>
							</li>
						</ul>
					</div>
					
					<a class="nav-link dropdown-toggle" href="https://example.com" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Places</a>
					
					<div class="dropdown-menu" aria-labelledby="dropdown01"> <!-- List all Places -->
						<ul class="list-group">
							<a  href="#" class="list-group-item list-group-item-action"></a>
						</ul>
					</div>
					
					<form class="form-inline my-2 my-lg-0"> <!-- Search for a Place -->
						<input  class="form-control mr-sm-2" type="text" placeholder="Search for a Place" aria-label="Search">
						<button class="btn btn-outline-success my-2 my-sm-0" type="submit">Go</button>
					</form>
				</nav>
				
				<!-- The Google Map -->
				<main role="main" class="container">
					<div class="starter-template">
						<div id="map"></div>
					</div>
				</main>

        <!-- Bootstrap javascript -->
        <script>
            // Model Places array of 5 places with name and address.
var Places = {{places}};

// Global variables. Empty array for markers and infoWindow variable.
var markers = [];
var infoWindow;

// This function allows for the Google Map to be rendered as well as all markers to be created.
function initMap() {

// Constructor creates a new map.
map = new google.maps.Map(document.getElementById('map'), {
	center: {lat: 29.976480, lng: 31.131302},
	zoom: 3,
	mapTypeControl: true,
	mapTypeControlOptions: {
		style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
		position: google.maps.ControlPosition.BOTTOM_CENTER
	}
});


// Declare a new geocoder object.
var geocoder = new google.maps.Geocoder();

// For each place in Places, call the geocodePlace function which geocodes the addresses.
Places.forEach(function(place) {
	geocodePlace(geocoder, place, map);
});

// Declare a new infoWindow object.
infoWindow = new google.maps.InfoWindow();

}

// This function allows each marker to be clicked triggering a google maps marker event.
function clickMarker(name) {
markers.forEach(function(markerItem) {
	if (markerItem.name == name) {
		google.maps.event.trigger(markerItem.marker,
			'click');
	}
});
}

// This function allows a marker to have a bounce animation.
function markerBounce(marker) {
if (marker.getAnimation() !== null) {
	marker.setAnimation(null);
} else {
	marker.setAnimation(google.maps.Animation.BOUNCE);
	setTimeout(function() {
		marker.setAnimation(null);
	}, 1200);
}
}

// geocodes the address passed from the forEach function, for each place in Places.
function geocodePlace(geocoder, place, placesMap) {

var latlng = {
	lat: parseFloat(place.lat),
	lng: parseFloat(place.lng)
};

// Uses Google's geocode method to parse the latlng of the place.address then set it on map.
geocoder.geocode({
	'location': latlng
}, function(results, status) {
	if (status === 'OK') {
		placesMap.setCenter(results[0].geometry.location);

		// Create a new place marker object based on geocode latlng results.
		// Animate the marker.
		place.marker = new google.maps.Marker({
			map: placesMap,
			position: latlng,
			animation: google.maps.Animation.DROP,
		});

		// Add name and marker to marker object.
		markers.push({
			name: place.name,
			marker: place.marker
		});

		// Event listener for when user clicks on marker.
		// Clicking marker will show the Wikipedia info and bounce the marker.
		google.maps.event.addListener(place.marker,
			'click',
			function() {
				placetext(place);
				markerBounce(place.marker);
				map.panTo(place.marker.position)
			});

		//Resize Function
		google.maps.event.addDomListener(window, "resize",
			function() {
				var center = map.getCenter();
				google.maps.event.trigger(map,
					"resize");
				map.setCenter(center);
			});

	} else {
		alert('This location has an invalid address.');
	}
});
}

// This function generates infowindow content.
function placetext(place) {
	// If marker clicked, open; if open, and x closed, close.
	if (infoWindow.marker != place.marker) {
		infoWindow.marker = place.marker;
		infoWindow.open(map, place.marker);
		infoWindow.addListener('closeclick', function() {
			infoWindow.setMarker = null;
		});
		
		// Set the content of the ajax query to the infoWindow.
		infoWindow.setContent('<div class="infoWindow"><h5>' + place.name +
							  '</h5><br><h6>' + place.description +
							  '<br><br>Added by ' + place.creator + ' <br>on ' + place.date +'</h6)');
	};
}

// Google Maps API error handling.
function apiError() {
alert("There was an issue loading the Google Maps API.");
}
        </script>	
		<script src="{{url_for('static', filename='bootstrap.min.js')}}"></script>
		<script src="{{url_for('static', filename='popper.min.js')}}"></script>
		<script src="{{url_for('static', filename='holder.min.js')}}"></script>
		<!-- Google API -->
		<script async defer
    	src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyBGNG2E7taR9czX5cF1PPWERZekDUXzyO8&callback=initMap">
  		</script>
	</body>
</html>